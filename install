#!/usr/bin/env bash
# shellcheck disable=SC2016,SC2119,SC2120
#
# Setup and install the .github templates in a repo.
#
# Copyright 2020 Justin Hartman (https://hartan.me)
# Author:  Justin Hartman <justin@hartman.me>
# Version: 1.0.0
# Link:    https://github.com/justinhartman/.github
# License: MIT https://opensource.org/licenses/MIT
#
set -e

#######################################
# Reusable variables.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
configs() {
    REPO=https://github.com/justinhartman/.github
    APP_VERSION=$(latest-version)
    FOLDER=".github-${APP_VERSION}"

    export DTMP WTMP REPO APP_VERSION FOLDER
}

#######################################
# Indent method for terminal messages.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
indent() {
    case "$OS" in
        darwin)
            sed -E 's/^/       /'
            ;;
        *)
            sed -u 's/^/       /'
            ;;
    esac
}

#######################################
# Get latest release version number
# from GitHub.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   String   Latest version number.
#######################################
latest-version() {
    curl -fsi "${REPO}"/releases/latest | grep -Fi location | sed 's@.*/@@' | tr -d '[:cntrl:]'
}

#######################################
# Download archive from GitHub for both
# Windows or macOS/Linux and extract to
# current folder.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
download() {
    echo "-----> Downloding the latest release from GitHub."

    case "$OS" in
        windows)
            zip="${REPO}/archive/${APP_VERSION}.zip"
            curl -fsSLO "$zip"
            unzip "$(basename "$zip")"
            rm -f "$(basename "$zip")"
            echo "Downloaded and extracted all files." | indent
            ;;
        *)
            curl -fsSL "${REPO}/archive/${APP_VERSION}.tar.gz" | tar -xz
            echo "Downloaded and extracted all files." | indent
            ;;
    esac
}

#######################################
# Copy core GitHub templates to the
# current folder.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
move() {
    echo "-----> Copying core GitHub files to your repo."
    cp -R "${FOLDER}"/templates/_core/ "$(pwd)"/
    echo "Copied the core GitHub files to $(pwd)" | indent
}

#######################################
# Copy and rename a license file from
# the licenses folder to the current
# directory.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
license() {
    echo "-----> Copying and renaming the license file."

    if cp "${FOLDER}/templates/_licenses/${LICENSE}" "$(pwd)"/LICENSE; then
        echo "Copied the ${LICENSE} license to $(pwd)/LICENSE" | indent
    else
        echo "ERROR: You entered an incorrect filename for the license." | indent
        # Run the cleanup method to clear temp files.
        cleanup-error
        # Notify user to try again.
        echo "-----> Please run the command again with a valid license filename. Example:"
        echo "curl -fsSL https://github.com/justinhartman/.github/raw/master/install | bash -s mit.txt" | indent
        echo "For a full list of available license files, go to https://git.io/JJm4H" | indent

        # Exit with an error.
        exit 1
    fi
}

#######################################
# Remove and cleanup any temporary
# working files from the current
# directory.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
cleanup() {
    echo "-----> Cleaning up temporary files."
    rm -rf "${FOLDER}"
    echo "Removed all temporary files and folders." | indent
}

#######################################
# Remove and cleanup all files from the
# the current working directory. This
# removes all core files as well as
# temp files as this is only called on
# an error happening with the install.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
cleanup-error() {
    echo "-----> Cleaning up all installed files and folders."
    # Remove the extracted folder as well all the core files already copied.
    rm -rf "${FOLDER}" .github .gitignore ./*.md
    echo "Removed all install and temporary files and folders." | indent
}

#######################################
# Run the main application methods.
# Globals:
#   None
# Arguments:
#   None
# Returns:
#   None
#######################################
main() {
    echo "-----> Starting the template build."
    # Setup the configuration variables.
    configs
    # Download and extract latest release.
    download
    # Copy core files to repo.
    move
    # Copy and rename license file.
    license
    # Remove any temporary working files.
    cleanup
}

# Get the Operating System name.
OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
case "$OS" in
    mingw* | msys*) OS=windows ;;
esac

# Check the license file argument is not blank.
LICENSE="${1#v}"
if [ -z "$LICENSE" ]; then
    echo "-----> Error: You must select a license file to use with your project."
    echo "Example: 'mit.txt' for MIT license, 'apache-2.0.txt' for Apache, etc." | indent
    echo "For a full list of available license files, go to https://git.io/JJm4H" | indent
    echo "-----> Please run the command again. Example:"
    echo "curl -fsSL https://github.com/justinhartman/.github/raw/master/install | bash -s mit.txt" | indent

    # Exit with an error.
    exit 1
else
    # Run the method.
    main
    # Confirm the end of the build.
    echo "-----> The .github templates have been installed at: $(pwd)"
    echo "-----> Done."

    # Exit gracefully.
    exit 0
fi
